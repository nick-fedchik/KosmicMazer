--[[
================================================================================
KOSMICMAZER ‚Äî Location_1 Game Server
================================================================================

Purpose: –°–µ—Ä–≤–µ—Ä–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≥—Ä–∏ –¥–ª—è Location_1 (–°–∞–¥–æ—á–æ–∫) –Ω–∞ Planet_1
Version: 1.0

Features:
- –ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –¥–ª—è —Ü—ñ—î—ó –ª–æ–∫–∞—Ü—ñ—ó
- –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ –ª–æ–∫–∞—Ü—ñ—ó
- –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π –≥—Ä–∞–≤—Ü—ñ–≤
- –ú—ñ–Ω—ñ-—ñ–≥—Ä–∏ –ª–æ–∫–∞—Ü—ñ—ó
- –ö–≤–µ—Å—Ç–∏ –ª–æ–∫–∞—Ü—ñ—ó
- NPC –ª–æ–≥—ñ–∫–∞

API:
- Initialize(locationModel): –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Å–∏—Å—Ç–µ–º—É –≥—Ä–∏ –¥–ª—è –ª–æ–∫–∞—Ü—ñ—ó
- Cleanup(): –û—á–∏—â–∞—î –≤—Å—ñ –ø–æ–¥—ñ—ó —Ç–∞ –æ–±'—î–∫—Ç–∏
- OnPlayerEnter(player): –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∫–æ–ª–∏ –≥—Ä–∞–≤–µ—Ü—å –≤—Ö–æ–¥–∏—Ç—å –≤ –ª–æ–∫–∞—Ü—ñ—é
- OnPlayerLeave(player): –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∫–æ–ª–∏ –≥—Ä–∞–≤–µ—Ü—å –ø–æ–∫–∏–¥–∞—î –ª–æ–∫–∞—Ü—ñ—é
- GetLocationRules(): –ü–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏ –ª–æ–∫–∞—Ü—ñ—ó

Calls to:
- PlanetConfig: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω–∏—Ö –ø—Ä–∞–≤–∏–ª
- GameConfig: –ó–∞–≥–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏
- PlayerDataManager: –î–∞–Ω—ñ —Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—ñ—è –≥—Ä–∞–≤—Ü—è
- ResourceController: –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å–∞–º–∏

Called from:
- LocationManager: –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó
- EnvironmentLoader: –ü—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

Dependencies:
- PlanetConfig module (Planet_1)
- GameConfig module
- PlayerDataManager module

ChangeLog:
- Version 1.0: Initial template for location-specific game logic

================================================================================
]]

local LocationGameServer = {}

--============================================================================--
-- SERVICES
--============================================================================--
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local CollectionService = game:GetService("CollectionService")

--============================================================================--
-- DEPENDENCIES
--============================================================================--
local GameConfig = require(game.ServerScriptService:WaitForChild("GameConfig"))

-- Load PlanetConfig from ServerStorage
local PlanetConfig
pcall(function()
	local planet1Folder = ServerStorage:WaitForChild("Planets"):WaitForChild("Planet_1")
	local configFolder = planet1Folder:WaitForChild("Configuration")
	PlanetConfig = require(configFolder:WaitForChild("PlanetConfig"))
end)

--============================================================================--
-- –ö–û–ù–°–¢–ê–ù–¢–ò –õ–û–ö–ê–¶–Ü–á / LOCATION CONSTANTS
--============================================================================--

LocationGameServer.LOCATION_ID = "Location_1"
LocationGameServer.LOCATION_NAME = "–°–∞–¥–æ—á–æ–∫"
LocationGameServer.PLANET_ID = "Planet_1"

--============================================================================--
-- –°–¢–ê–ù –õ–û–ö–ê–¶–Ü–á / LOCATION STATE
--============================================================================--

-- –ú–æ–¥–µ–ª—å –ª–æ–∫–∞—Ü—ñ—ó
local locationModel = nil

-- –ê–∫—Ç–∏–≤–Ω—ñ –≥—Ä–∞–≤—Ü—ñ –≤ –ª–æ–∫–∞—Ü—ñ—ó
local activePlayers = {}

-- –†–µ—Å—É—Ä—Å–∏ –ª–æ–∫–∞—Ü—ñ—ó
local resources = {}

-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø–æ–¥—ñ–π
local connections = {}

-- –ß–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–∫–∞—Ü—ñ—è
local isInitialized = false

--============================================================================--
-- –ü–†–ê–í–ò–õ–ê –ì–†–ò –õ–û–ö–ê–¶–Ü–á / LOCATION GAME RULES
--============================================================================--

LocationGameServer.LOCATION_RULES = {
	-- –ù–∞–∑–≤–∞ —Ç–∞ –æ–ø–∏—Å
	DisplayName = "–°–∞–¥–æ—á–æ–∫",
	Description = "–°—Ç–∞—Ä—Ç–æ–≤–∞ –ª–æ–∫–∞—Ü—ñ—è –¥–ª—è –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞ –∑ –≥—Ä–æ—é",

	-- –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –ª–æ–∫–∞—Ü—ñ—ó
	Features = {
		HasResources = true,
		HasNPCs = true,
		HasQuests = true,
		HasMinigames = false,
		HasShop = true
	},

	-- –õ—ñ–º—ñ—Ç–∏
	MaxPlayers = 10,
	ResourceDensity = 1.2, -- –ë—ñ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å—ñ–≤ –Ω—ñ–∂ –Ω–∞ —ñ–Ω—à–∏—Ö –ª–æ–∫–∞—Ü—ñ—è—Ö

	-- –ë–µ–∑–ø–µ–∫–∞
	IsSafeZone = true, -- –ù–µ –º–æ–∂–Ω–∞ –∞—Ç–∞–∫—É–≤–∞—Ç–∏ –≥—Ä–∞–≤—Ü—ñ–≤

	-- –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
	DifficultyLevel = 1, -- –õ–µ–≥–∫–∞ –ª–æ–∫–∞—Ü—ñ—è
	RecommendedLevel = 1
}

--============================================================================--
-- –õ–û–ö–ê–õ–¨–ù–Ü –§–£–ù–ö–¶–Ü–á / LOCAL FUNCTIONS
--============================================================================--

--[[
–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î —Ä–µ—Å—É—Ä—Å–∏ –ª–æ–∫–∞—Ü—ñ—ó
]]
local function loadResources()
	print("[LocationGameServer] üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤ –¥–ª—è", LocationGameServer.LOCATION_NAME)

	if not locationModel then
		warn("[LocationGameServer] ‚ö†Ô∏è Location model not set")
		return
	end

	-- –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –æ–±'—î–∫—Ç–∏ –∑ —Ç–µ–≥–æ–º "Resource"
	local resourceObjects = CollectionService:GetTagged("Location_1_Resource")

	for _, resourceObj in ipairs(resourceObjects) do
		table.insert(resources, {
			Object = resourceObj,
			Type = resourceObj:GetAttribute("ResourceType") or "Ore",
			Respawning = false,
			LastHarvested = 0
		})
	end

	print("[LocationGameServer] ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ä–µ—Å—É—Ä—Å—ñ–≤:", #resources)
end

--[[
–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î NPC –≤ –ª–æ–∫–∞—Ü—ñ—ó
]]
local function initializeNPCs()
	print("[LocationGameServer] üë• –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è NPC –¥–ª—è", LocationGameServer.LOCATION_NAME)

	if not locationModel then
		warn("[LocationGameServer] ‚ö†Ô∏è Location model not set")
		return
	end

	-- –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ—Ö NPC –≤ –ª–æ–∫–∞—Ü—ñ—ó
	local npcsFolder = locationModel:FindFirstChild("NPCs")
	if npcsFolder then
		for _, npc in ipairs(npcsFolder:GetChildren()) do
			if npc:IsA("Model") then
				-- TODO: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ NPC –ª–æ–≥—ñ–∫—É
				print("[LocationGameServer] üë§ NPC –∑–Ω–∞–π–¥–µ–Ω–æ:", npc.Name)
			end
		end
	end
end

--[[
–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î –∫–≤–µ—Å—Ç–∏ –ª–æ–∫–∞—Ü—ñ—ó
]]
local function initializeQuests()
	print("[LocationGameServer] üìú –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–≤–µ—Å—Ç—ñ–≤ –¥–ª—è", LocationGameServer.LOCATION_NAME)

	-- TODO: –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–≤–µ—Å—Ç–∏ –∑ –∫–æ–Ω—Ñ—ñ–≥—É
	-- TODO: –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –∫–≤–µ—Å—Ç–∏ –≤ QuestManager
end

--[[
–û–±—Ä–æ–±–ª—è—î –∑–±—ñ—Ä —Ä–µ—Å—É—Ä—Å—É –≥—Ä–∞–≤—Ü–µ–º
]]
local function onResourceHarvested(player, resource)
	print("[LocationGameServer] ‚õèÔ∏è –ì—Ä–∞–≤–µ—Ü—å", player.Name, "–∑—ñ–±—Ä–∞–≤ —Ä–µ—Å—É—Ä—Å:", resource.Type)

	-- TODO: –î–æ–¥–∞—Ç–∏ —Ä–µ—Å—É—Ä—Å –≤ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä –≥—Ä–∞–≤—Ü—è
	-- TODO: –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ä–µ—Å–ø–∞–≤–Ω —Ä–µ—Å—É—Ä—Å—É
end

--============================================================================--
-- –ü–£–ë–õ–Ü–ß–ù–Ü –§–£–ù–ö–¶–Ü–á / PUBLIC API
--============================================================================--

--[[
@function Initialize
–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Å–∏—Å—Ç–µ–º—É –≥—Ä–∏ –¥–ª—è –ª–æ–∫–∞—Ü—ñ—ó

@param model Model - –ú–æ–¥–µ–ª—å –ª–æ–∫–∞—Ü—ñ—ó –≤ Workspace
@return boolean - –£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
]]
function LocationGameServer.Initialize(model)
	if isInitialized then
		warn("[LocationGameServer] ‚ö†Ô∏è Already initialized for", LocationGameServer.LOCATION_NAME)
		return false
	end

	print("[LocationGameServer] üéÆ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—Ä–∏ –¥–ª—è –ª–æ–∫–∞—Ü—ñ—ó:", LocationGameServer.LOCATION_NAME)

	locationModel = model

	-- –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –ª–æ–∫–∞—Ü—ñ—ó
	loadResources()
	initializeNPCs()
	initializeQuests()

	-- –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞
	if PlanetConfig then
		PlanetConfig.ApplyPlanetPhysics()
		print("[LocationGameServer] ‚úÖ –ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —Ñ—ñ–∑–∏–∫—É –ø–ª–∞–Ω–µ—Ç–∏")
	end

	isInitialized = true
	print("[LocationGameServer] ‚úÖ –õ–æ–∫–∞—Ü—ñ—è", LocationGameServer.LOCATION_NAME, "—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞")

	return true
end

--[[
@function Cleanup
–û—á–∏—â–∞—î –≤—Å—ñ –ø–æ–¥—ñ—ó —Ç–∞ –æ–±'—î–∫—Ç–∏

@return nil
]]
function LocationGameServer.Cleanup()
	print("[LocationGameServer] üßπ –û—á–∏—â–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó:", LocationGameServer.LOCATION_NAME)

	-- –í—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≤—Å—ñ –ø–æ–¥—ñ—ó
	for _, connection in ipairs(connections) do
		connection:Disconnect()
	end
	connections = {}

	-- –û—á–∏—Å—Ç–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤
	activePlayers = {}

	-- –û—á–∏—Å—Ç–∏—Ç–∏ —Ä–µ—Å—É—Ä—Å–∏
	resources = {}

	locationModel = nil
	isInitialized = false

	print("[LocationGameServer] ‚úÖ –õ–æ–∫–∞—Ü—ñ—é –æ—á–∏—â–µ–Ω–æ")
end

--[[
@function OnPlayerEnter
–í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∫–æ–ª–∏ –≥—Ä–∞–≤–µ—Ü—å –≤—Ö–æ–¥–∏—Ç—å –≤ –ª–æ–∫–∞—Ü—ñ—é

@param player Player - –ì—Ä–∞–≤–µ—Ü—å —â–æ –≤—Ö–æ–¥–∏—Ç—å
@return nil
]]
function LocationGameServer.OnPlayerEnter(player)
	print("[LocationGameServer] üëã –ì—Ä–∞–≤–µ—Ü—å", player.Name, "—É–≤—ñ–π—à–æ–≤ –≤", LocationGameServer.LOCATION_NAME)

	activePlayers[player.UserId] = {
		Player = player,
		EnterTime = tick(),
		ResourcesCollected = 0
	}

	-- TODO: –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ª–æ–∫–∞—Ü—ñ—é
	-- TODO: –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∫–≤–µ—Å—Ç–∏
	-- TODO: –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–∞–Ω –ª–æ–∫–∞—Ü—ñ—ó –¥–ª—è –≥—Ä–∞–≤—Ü—è
end

--[[
@function OnPlayerLeave
–í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∫–æ–ª–∏ –≥—Ä–∞–≤–µ—Ü—å –ø–æ–∫–∏–¥–∞—î –ª–æ–∫–∞—Ü—ñ—é

@param player Player - –ì—Ä–∞–≤–µ—Ü—å —â–æ –≤–∏—Ö–æ–¥–∏—Ç—å
@return nil
]]
function LocationGameServer.OnPlayerLeave(player)
	print("[LocationGameServer] üëã –ì—Ä–∞–≤–µ—Ü—å", player.Name, "–ø–æ–∫–∏–Ω—É–≤", LocationGameServer.LOCATION_NAME)

	local playerData = activePlayers[player.UserId]
	if playerData then
		-- TODO: –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å –≥—Ä–∞–≤—Ü—è
		-- TODO: –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

		local timeSpent = tick() - playerData.EnterTime
		print("[LocationGameServer] ‚è±Ô∏è –ß–∞—Å –≤ –ª–æ–∫–∞—Ü—ñ—ó:", math.floor(timeSpent), "—Å–µ–∫—É–Ω–¥")
		print("[LocationGameServer] üìä –ó—ñ–±—Ä–∞–Ω–æ —Ä–µ—Å—É—Ä—Å—ñ–≤:", playerData.ResourcesCollected)
	end

	activePlayers[player.UserId] = nil
end

--[[
@function GetLocationRules
–ü–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏ –ª–æ–∫–∞—Ü—ñ—ó

@return table - –¢–∞–±–ª–∏—Ü—è –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏
]]
function LocationGameServer.GetLocationRules()
	return LocationGameServer.LOCATION_RULES
end

--[[
@function GetActivePlayersCount
–ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤ –≤ –ª–æ–∫–∞—Ü—ñ—ó

@return number - –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤
]]
function LocationGameServer.GetActivePlayersCount()
	local count = 0
	for _ in pairs(activePlayers) do
		count = count + 1
	end
	return count
end

--[[
@function IsInitialized
–ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–∫–∞—Ü—ñ—è

@return boolean - –°—Ç–∞—Ç—É—Å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
]]
function LocationGameServer.IsInitialized()
	return isInitialized
end

return LocationGameServer

