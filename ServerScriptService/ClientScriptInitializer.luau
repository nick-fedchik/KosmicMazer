--[[
================================================================================
KOSMICMAZER â€” Client Script Initializer
================================================================================

Purpose: Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ” client scripts Ð¿Ñ–ÑÐ»Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð°
Version: 1.1

Features:
- Ð’Ð¸ÐºÐ»Ð¸ÐºÐ°Ñ” Initialize() Ð½Ð° client scripts Ð· environment context
- Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ÑˆÑƒÐº Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ñƒ Workspace
- Ð†Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ñ–Ñ Ð· LoadOrder ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾ÑŽ
- LocationModel hierarchical structure support

API:
- InitializeAllClientScripts(locationType, planetId, locationId): Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ” Ð²ÑÑ– client scripts
- CreateEnvironment(locationType, planetId, locationId): Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ” environment context

Dependencies:
- StarterPlayerScripts: Client scripts Ð´Ð»Ñ Ñ–Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ—
- Workspace: ÐœÐ¾Ð´ÐµÐ»Ñ– Ð´Ð»Ñ environment

ChangeLog:
- Version 1.1: Updated for LocationModel hierarchical structure (ETAP 3)
- Version 1.1: FindModel() now searches within LocationModel organizational sections
- Version 1.1: Added LocationModel attribute validation for SpaceStation type
- Version 1.1: Enhanced model discovery in Architecture/Equipment/Environment/Gameplay folders
- Version 1.1: Added fallback support for old SpaceStation structure
- Version 1.0: Initial implementation with environment context support

================================================================================
]]

local ClientScriptInitializer = {}

-- Services
local StarterPlayerScripts = game:GetService("StarterPlayer"):WaitForChild("StarterPlayerScripts")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

-- Client Environment Class
local ClientEnvironment = {}
ClientEnvironment.__index = ClientEnvironment

function ClientEnvironment.new(locationType, planetId, locationId)
	local self = setmetatable({}, ClientEnvironment)
	self.locationType = locationType or "Unknown"
	self.planetId = planetId or "Unknown"
	self.locationId = locationId or nil
	return self
end

-- Ð—Ð½Ð°Ð¹Ñ‚Ð¸ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñƒ Workspace Ð·Ð° Ð½Ð°Ð·Ð²Ð¾ÑŽ
function ClientEnvironment:FindModel(modelName)
	-- Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÑ”Ð¼Ð¾ Ñ€Ñ–Ð·Ð½Ñ– ÑˆÐ»ÑÑ…Ð¸ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ Ð²Ñ–Ð´ Ð»Ð¾ÐºÐ°Ñ†Ñ–Ñ—
	if self.locationType == "SpaceStation" then
		-- Ð”Ð»Ñ SpaceStation Ð¼Ð¾Ð´ÐµÐ»Ñ– Ð¼Ð¾Ð¶ÑƒÑ‚ÑŒ Ð±ÑƒÑ‚Ð¸ Ð²ÑÐµÑ€ÐµÐ´Ð¸Ð½Ñ– LocationModel
		local locationModel = Workspace:FindFirstChild("LocationModel")
		if locationModel then
			-- Ð’Ð°Ð»Ñ–Ð´ÑƒÑ”Ð¼Ð¾ Ñ‰Ð¾ Ñ†Ðµ SpaceStation LocationModel
			local locationId = locationModel:GetAttribute("LocationId")
			local locationType = locationModel:GetAttribute("LocationType")
			
			if locationId == "SpaceStation" and locationType == "Space" then
				-- Ð¨ÑƒÐºÐ°Ñ”Ð¼Ð¾ Ð² Ð¾Ñ€Ð³Ð°Ð½Ñ–Ð·Ð°Ñ†Ñ–Ð¹Ð½Ð¸Ñ… ÑÐµÐºÑ†Ñ–ÑÑ…
				for _, sectionName in ipairs({"Architecture", "Equipment", "Environment", "Gameplay"}) do
					local section = locationModel:FindFirstChild(sectionName)
					if section then
						local model = section:FindFirstChild(modelName)
						if model then return model end
					end
				end
				
				-- Ð¢Ð°ÐºÐ¾Ð¶ ÑˆÑƒÐºÐ°Ñ”Ð¼Ð¾ Ð¿Ñ€ÑÐ¼Ð¾ Ð² LocationModel (Ð´Ð»Ñ PrimaryPart Ñ‚Ð¾Ñ‰Ð¾)
				local model = locationModel:FindFirstChild(modelName)
				if model then return model end
			end
		end
		
		-- Fallback: ÑÑ‚Ð°Ñ€Ð¸Ð¹ SpaceStation Ð´Ð»Ñ ÑÑƒÐ¼Ñ–ÑÐ½Ð¾ÑÑ‚Ñ–
		local spaceStation = Workspace:FindFirstChild("SpaceStation")
		if spaceStation then
			local model = spaceStation:FindFirstChild(modelName)
			if model then return model end
		end
	elseif self.locationType == "Planet" then
		-- Ð”Ð»Ñ Ð¿Ð»Ð°Ð½ÐµÑ‚Ð¸ Ð¼Ð¾Ð´ÐµÐ»Ñ– Ð¼Ð¾Ð¶ÑƒÑ‚ÑŒ Ð±ÑƒÑ‚Ð¸ Ð² Ñ€Ñ–Ð·Ð½Ð¸Ñ… Ð¼Ñ–ÑÑ†ÑÑ…
		local planet = Workspace:FindFirstChild("Planet")
		if planet then
			local model = planet:FindFirstChild(modelName)
			if model then return model end
		end
	end
	
	-- Fallback: Ð¿Ð¾ÑˆÑƒÐº Ñƒ ÐºÐ¾Ñ€ÐµÐ½Ñ– Workspace
	return Workspace:FindFirstChild(modelName)
end

-- ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ñƒ Ð»Ð¾ÐºÐ°Ñ†Ñ–ÑŽ
function ClientEnvironment:GetLocation()
	if self.locationType == "SpaceStation" then
		return "SpaceStation"
	elseif self.locationType == "Planet" and self.locationId then
		local safePlanet = self.planetId or "UnknownPlanet"
		return string.format("%s/%s", safePlanet, self.locationId)
	else
		return self.locationType
	end
end

-- ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ñƒ Ð¿Ð»Ð°Ð½ÐµÑ‚Ñƒ
function ClientEnvironment:GetCurrentPlanet()
	return self.planetId
end

-- Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ environment Ð´Ð»Ñ client scripts
function ClientScriptInitializer.CreateEnvironment(locationType, planetId, locationId)
	return ClientEnvironment.new(locationType, planetId, locationId)
end

-- Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ Ð²ÑÑ– client scripts
function ClientScriptInitializer.InitializeAllClientScripts(locationType, planetId, locationId)
	print("[ClientScriptInitializer] ðŸš€ Initializing client scripts...")

	-- Normalize optional params to concrete strings for formatter safety
	local normalizedLocationType = locationType or "Unknown"
	local normalizedPlanetId = planetId or "N/A"
	local normalizedLocationId = locationId or "N/A"
	print(string.format("  â””â”€ Location: %s, Planet: %s, LocationId: %s",
		normalizedLocationType, normalizedPlanetId, normalizedLocationId))
	
	-- Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ environment
	local environment = ClientScriptInitializer.CreateEnvironment(locationType, planetId, locationId)
	
	-- Ð—Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð²ÑÑ– client scripts Ð² StarterPlayerScripts
	local clientScripts = StarterPlayerScripts:GetChildren()
	local initializedCount = 0
	
	for _, script in ipairs(clientScripts) do
		if script:IsA("LocalScript") then
			-- ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ñ‡Ð¸ script Ð¼Ð°Ñ” Initialize Ñ„ÑƒÐ½ÐºÑ†Ñ–ÑŽ
			local success, module = pcall(require, script)
			if success and type(module) == "table" and type(module.Initialize) == "function" then
				local initSuccess, initError = pcall(module.Initialize, environment)
				if initSuccess then
					print(string.format("[ClientScriptInitializer] âœ… Initialized: %s", script.Name))
					initializedCount = initializedCount + 1
				else
					warn(string.format("[ClientScriptInitializer] âŒ Failed to initialize %s: %s", 
						script.Name, tostring(initError)))
				end
			else
				print(string.format("[ClientScriptInitializer] â„¹ï¸ %s - no Initialize() function", script.Name))
			end
		end
	end
	
	print(string.format("[ClientScriptInitializer] ðŸŽ‰ Initialized %d/%d client scripts", 
		initializedCount, #clientScripts))
	
	return initializedCount > 0
end

return ClientScriptInitializer