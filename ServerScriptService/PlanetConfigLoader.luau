--[[
================================================================================
KOSMICMAZER ‚Äî Planet Config Loader
================================================================================

Purpose: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π –ø–ª–∞–Ω–µ—Ç –∑ ServerStorage
Version: 1.0

Features:
- –î–∏–Ω–∞–º—ñ—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è PlanetConfig –∑ ServerStorage/Planets/{PlanetId}
- –ö–µ—à—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É –ø–æ—Ç–æ—á–Ω–æ—ó –ø–ª–∞–Ω–µ—Ç–∏ –∑ GameConfig.DEFAULT_PLANET
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è —ñ—Å–Ω—É–≤–∞–Ω–Ω—è PlanetConfig —Ñ–∞–π–ª—ñ–≤

API:
- LoadPlanetConfig(planetId): –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–Ω—Ñ—ñ–≥ –ø–ª–∞–Ω–µ—Ç–∏ –∑ ServerStorage
- GetCurrentPlanetConfig(): –ü–æ–≤–µ—Ä—Ç–∞—î –∫–æ–Ω—Ñ—ñ–≥ DEFAULT_PLANET
- ClearCache(planetId?): –û—á–∏—â—É—î –∫–µ—à –¥–ª—è hot-reload

Calls to:
- GameConfig: –û—Ç—Ä–∏–º–∞–Ω–Ω—è DEFAULT_PLANET
- ServerStorage.Planets.{PlanetId}.Configuration.PlanetConfig

Called from:
- PlanetSurfaceScanner: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ–π –¥–ª—è —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
- TeleportationManager: –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –ª–æ–∫–∞—Ü—ñ–π
- DataStoreManager: –î–æ–¥–∞–≤–∞–Ω–Ω—è discovered locations
- ConfigValidator: –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–ª–∞–Ω–µ—Ç

Dependencies:
- ServerStorage/Planets/{PlanetId}/Configuration/PlanetConfig.luau
- ServerScriptService/GameConfig.luau

ChangeLog:
- Version 1.0: Initial implementation (2026-01-10)
  - LoadPlanetConfig –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º
  - GetCurrentPlanetConfig helper
  - ClearCache –¥–ª—è hot-reload
  - –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∞ error handling

================================================================================
]]

--============================================================================--
-- SERVICES
--============================================================================--
local ServerStorage = game:GetService("ServerStorage")

--============================================================================--
-- MODULES
--============================================================================--
local module = {}
module.Version = "1.0"

--============================================================================--
-- –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü / GLOBAL VARIABLES
--============================================================================--

-- @var table –ö–µ—à –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ –ø–ª–∞–Ω–µ—Ç {[planetId]: PlanetConfig}
local loadedConfigs = {}

--============================================================================--
-- –ü–£–ë–õ–Ü–ß–ù–Ü –§–£–ù–ö–¶–Ü–á / PUBLIC API
--============================================================================--

--[[
@function LoadPlanetConfig
–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ø–ª–∞–Ω–µ—Ç–∏ –∑ ServerStorage

@param planetId string - ID –ø–ª–∞–Ω–µ—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "Planet_1")
@return table - PlanetConfig module
@throws error —è–∫—â–æ –ø–ª–∞–Ω–µ—Ç–∞ –∞–±–æ –∫–æ–Ω—Ñ—ñ–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ

@example
    local config = PlanetConfigLoader.LoadPlanetConfig("Planet_1")
    print("Planet name:", config.DISPLAY_NAME)
]]
function module.LoadPlanetConfig(planetId: string)
	-- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à—É
	if loadedConfigs[planetId] then
		return loadedConfigs[planetId]
	end

	-- –ü–æ—à—É–∫ –ø–∞–ø–∫–∏ Planets –≤ ServerStorage
	local planetsFolder = ServerStorage:FindFirstChild("Planets")
	if not planetsFolder then
		error("[PlanetConfigLoader] ‚ùå ServerStorage.Planets folder not found")
	end

	-- –ü–æ—à—É–∫ –ø–∞–ø–∫–∏ –ø–ª–∞–Ω–µ—Ç–∏
	local planetFolder = planetsFolder:FindFirstChild(planetId)
	if not planetFolder then
		error(string.format("[PlanetConfigLoader] ‚ùå Planet '%s' not found in ServerStorage.Planets", planetId))
	end

	-- –ü–æ—à—É–∫ –ø–∞–ø–∫–∏ Configuration
	local configFolder = planetFolder:FindFirstChild("Configuration")
	if not configFolder then
		error(string.format("[PlanetConfigLoader] ‚ùå Configuration folder not found for planet '%s'", planetId))
	end

	-- –ü–æ—à—É–∫ –º–æ–¥—É–ª—è PlanetConfig
	local configModule = configFolder:FindFirstChild("PlanetConfig")
	if not configModule then
		error(string.format("[PlanetConfigLoader] ‚ùå PlanetConfig module not found for planet '%s'", planetId))
	end

	-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
	local success, config = pcall(require, configModule)
	if not success then
		error(string.format("[PlanetConfigLoader] ‚ùå Failed to load PlanetConfig for '%s': %s",
			planetId, tostring(config)))
	end

	-- –ö–µ—à—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É
	loadedConfigs[planetId] = config

	-- –õ–æ–≥—É–≤–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
	print(string.format("[PlanetConfigLoader] ‚úÖ Loaded PlanetConfig for '%s' (%s)",
		planetId, config.DISPLAY_NAME or config.PLANET_NAME or "Unknown"))

	return config
end

--[[
@function GetCurrentPlanetConfig
–ü–æ–≤–µ—Ä—Ç–∞—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ø–æ—Ç–æ—á–Ω–æ—ó –ø–ª–∞–Ω–µ—Ç–∏ –∑ GameConfig.DEFAULT_PLANET

@return table - PlanetConfig –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –ø–ª–∞–Ω–µ—Ç–∏
@throws error —è–∫—â–æ DEFAULT_PLANET –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –∞–±–æ –∫–æ–Ω—Ñ—ñ–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π

@example
    local currentConfig = PlanetConfigLoader.GetCurrentPlanetConfig()
    for locationId, location in pairs(currentConfig.LOCATIONS) do
        print("Location:", location.DisplayName)
    end
]]
function module.GetCurrentPlanetConfig()
	local GameConfig = require(script.Parent:FindFirstChild("GameConfig"))

	if not GameConfig.DEFAULT_PLANET then
		error("[PlanetConfigLoader] ‚ùå GameConfig.DEFAULT_PLANET is not set")
	end

	return module.LoadPlanetConfig(GameConfig.DEFAULT_PLANET)
end

--[[
@function ClearCache
–û—á–∏—â—É—î –∫–µ—à –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ (–¥–ª—è hot-reload –ø—ñ–¥ —á–∞—Å —Ä–æ–∑—Ä–æ–±–∫–∏)

@param planetId string? - –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ, ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –ø–ª–∞–Ω–µ—Ç–∏ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è.
                          –Ø–∫—â–æ nil - –æ—á–∏—â–∞—î –≤–µ—Å—å –∫–µ—à.

@example
    -- –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –ø–ª–∞–Ω–µ—Ç–∏
    PlanetConfigLoader.ClearCache("Planet_1")

    -- –û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å –∫–µ—à
    PlanetConfigLoader.ClearCache()
]]
function module.ClearCache(planetId: string?)
	if planetId then
		loadedConfigs[planetId] = nil
		print(string.format("[PlanetConfigLoader] üîÑ Cache cleared for '%s'", planetId))
	else
		loadedConfigs = {}
		print("[PlanetConfigLoader] üîÑ All cache cleared")
	end
end

return module
